{%- if settings.cart_type == 'drawer' -%}
  <div id="CartDrawer" class="drawer drawer--right">
    <form id="CartDrawerForm" action="{{ routes.cart_url }}" method="post" novalidate class="drawer__contents" data-location="cart-drawer">
      <div class="drawer__fixed-header">
        <div class="drawer__header appear-animation appear-delay-1">
          <div class="h2 drawer__title">{{ 'cart.general.title' | t }}</div>
          <div class="drawer__close">
            <button type="button" class="drawer__close-button js-drawer-close">
              <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-close" viewBox="0 0 64 64"><title>icon-X</title><path d="m19 17.61 27.12 27.13m0-27.12L19 44.74"/></svg>
              <span class="icon__fallback-text">{{ 'cart.general.close_cart' | t }}</span>
            </button>
          </div>
        </div>
      </div>

      <div class="drawer__inner">
        <div class="drawer__scrollable">
          <div data-products class="appear-animation appear-delay-2"></div>

          {% if settings.cart_notes_enable %}
            <div class="appear-animation appear-delay-3">
              <label for="CartNoteDrawer">{{ 'cart.general.note' | t }}</label>
              <textarea name="note" class="input-full cart-notes" id="CartNoteDrawer">{{ cart.note }}</textarea>
            </div>
          {% endif %}

          <div id="CartDrawerRecommendations"></div>
        </div>

        <div class="drawer__footer appear-animation appear-delay-4">
          <div data-discounts>
            {% if cart.cart_level_discount_applications != blank %}
              <div class="cart__discounts cart__item-sub cart__item-row">
                <div>{{ 'cart.general.discounts' | t }}</div>
                <div class="text-right">
                  {% for cart_discount in cart.cart_level_discount_applications %}
                    <div class="cart__discount">
                      {{ cart_discount.title }} (-{{ cart_discount.total_allocated_amount | money }})
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>

          <div class="cart__item-sub cart__item-row">
            <div class="ajaxcart__subtotal">{{ 'cart.general.subtotal' | t }}</div>
            <div data-subtotal>{{ cart.total_price | money }}</div>
          </div>

          <div class="cart__item-row text-center">
            <small>
              {{ 'cart.general.shipping_at_checkout' | t }}<br />
            </small>
          </div>

          {% if settings.cart_terms_conditions_enable %}
            <div class="cart__item-row cart__terms">
              <input type="checkbox" id="CartTermsDrawer" class="cart__terms-checkbox">
              <label for="CartTermsDrawer">
                {% if settings.cart_terms_conditions_page != blank %}
                  {{ 'cart.general.terms_html' | t: url: settings.cart_terms_conditions_page.url }}
                {% else %}
                  {{ 'cart.general.terms' | t }}
                {% endif %}
              </label>
            </div>
          {% endif %}

          <div class="cart__checkout-wrapper">
            <button type="submit" name="checkout" data-terms-required="{{ settings.cart_terms_conditions_enable }}" class="btn cart__checkout">
              {{ 'cart.general.checkout' | t }}
            </button>

            {% if additional_checkout_buttons and settings.cart_additional_buttons %}
              <div class="additional-checkout-buttons additional-checkout-buttons--vertical">{{ content_for_additional_checkout_buttons }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="drawer__cart-empty appear-animation appear-delay-2">
        <div class="drawer__scrollable">
          {{ 'cart.general.empty' | t }}
        </div>
      </div>
    </form>
  </div>
{%- endif -%}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Simple delegated listener for ajax add to cart buttons in drawer
    // Since these are dynamic, we need delegation or re-binding.
    // However, existing theme.js often handles .ajax-add-to-cart class if present.
    // If not, we might need custom JS. 
    // Usually theme.js attaches to '.btn--add-to-cart' or form submit.
    
    // Add dynamic recommendations logic
    const container = document.getElementById('CartDrawerRecommendations');
    
    function loadRecommendations(productId) {
      if (!productId) {
        container.innerHTML = '';
        return;
      }
      
      const url = `${window.Shopify.routes.root}recommendations/products?section_id=cart-drawer-recommendations&product_id=${productId}&limit=4`;
      
      fetch(url)
        .then(response => response.text())
        .then(text => {
          const html = document.createElement('div');
          html.innerHTML = text;
          const recommendations = html.querySelector('.drawer__upsell');
          
          if (recommendations && recommendations.innerHTML.trim().length) {
            container.innerHTML = recommendations.outerHTML;
          } else {
            container.innerHTML = '';
          }
        })
        .catch(e => {
          console.error(e);
        });
    }

    // Listen for cart updates
    document.addEventListener('cart:updated', function(evt) {
      const cart = evt.detail.cart;
      if (cart.items.length > 0) {
        const firstItem = cart.items[0];
        loadRecommendations(firstItem.product_id);
      } else {
        container.innerHTML = '';
      }
    });

    // Initial load check if cart has items
    fetch(window.Shopify.routes.root + 'cart.js')
      .then(res => res.json())
      .then(cart => {
        if (cart.items.length > 0) {
          loadRecommendations(cart.items[0].product_id);
        }
      });
      
    document.querySelector('#CartDrawer').addEventListener('click', function(e) {
      if (e.target.matches('.ajax-add-to-cart')) {
        e.preventDefault();
        var variantId = e.target.getAttribute('data-id');
        var btn = e.target;
        btn.classList.add('btn--loading');
        
        var formData = new FormData();
        formData.append('items[][id]', variantId);
        formData.append('items[][quantity]', 1);

        fetch(window.Shopify.routes.root + 'cart/add.js', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          return response.json();
        })
        .then(data => {
          // Trigger cart update event that the theme listens to
          document.dispatchEvent(new CustomEvent('cart:build'));
          
          // Refresh recommendations
          fetch(window.Shopify.routes.root + 'cart.js')
            .then(res => res.json())
            .then(cart => {
               document.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart: cart } }));
            });

           btn.classList.remove('btn--loading');
           btn.innerText = 'Added';
        })
        .catch((error) => {
          console.error('Error:', error);
          btn.classList.remove('btn--loading');
        });
      }
    });
  });
</script>

<style>
  .drawer__upsell {
    padding: 20px;
    border-top: 1px solid var(--colorBorder);
  }
  .drawer__upsell-title {
    margin-bottom: 15px;
    font-size: 1.1em;
  }
  .drawer__upsell-item {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .drawer__upsell-image {
    width: 60px;
    flex-shrink: 0;
  }
  .drawer__upsell-content {
    flex-grow: 1;
  }
  .drawer__upsell-name {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    text-decoration: none;
    color: inherit;
  }
  .drawer__upsell-price {
    margin-bottom: 10px;
  }
</style>


{% schema %}
{
  "name": "Cart Drawer",
  "settings": [],
  "blocks": [
    {
      "type": "upsell",
      "name": "Upsell Product",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Heading",
          "default": "You might also like"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ]
}
{% endschema %}
